<!doctype html>
<html>
<head>
    <script src="js/jquery-2.0.3.js"></script>
    <style type="text/css">
        .ball {
            border-radius: 5px;
            background-color: blue;
            width: 10px;
            height: 10px;
        }
        .bread {
            background-color: brown;
            width: 10px;
            height: 10px;
        }
        .production {
            background-color: yellow;
            width: 5px;
            height: 5px;
        }
    </style>
    <script type="text/javascript">
        $(document).ready(function() {
            var maxSpeed = 5;
            var looseSpeedOnCrash = 0.8;
            var mouse = {};
            var boxHeight = $('#box').height(), boxWidth = $('#box').width();
            var boxTop = $('#box').position().top, boxLeft = $('#box').position().left;
            var balls = [];
            var food = [];
            var production = [];
            setInterval(function () {
                $('#objects_cnt').text(balls.length);
            }, 500);

            var SoundLib = function() {
                this.sounds = {};
                var audioElement = document.createElement('audio');
                audioElement.setAttribute('src', 'chaw.mp3?1');
                audioElement.setAttribute('type', 'audio/mpeg');
                this.sounds.chaw = audioElement;
            };
            SoundLib.prototype.play = function(soundName) {
                this.sounds[soundName].play();
            };
            var sounds = new SoundLib();

            var mouseActionCreateObj = function(x, y) {
                if (balls.length < 20) {
                    balls.push(new Ball(x, y));
                }
            };
            var mouseActionAddBread = function(x, y) {
                food.push(new Food(x, y));
                console.log(food);
            };
            function main() {
                var box = $("#box");
                box.width(boxWidth);
                box.height(boxHeight);
                balls.push(new Ball(boxWidth/2, boxHeight/2));
                $("#box").click(function(e) {
                     mouse.action(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
                });
                $("#menu div").click(function() {
                    $("#menu div").css("border", 0);
                    $(this).css("border", "3px solid red");
                });
                $("#bread").click(function() {
                    mouse.action = mouseActionAddBread;
                });
                $("#ball").click(function() {
                    mouse.action = mouseActionCreateObj;
                });
                mouse.action = mouseActionCreateObj;
            }
            function randSign() {
                var rnd;
                rnd = Math.random();
                if (rnd < 0.5) return -1;
                if (rnd == 0.5) return 0;
                return 1;
            }
            function Entity(x, y) {
                x = x || 0;
                y = y || 0;
                this.vx = 0;
                this.vy = 0;
                this.x = 0;
                this.y = 0;
            }
            function Ball(x, y) {
                var objHeight = 10, objWidth = 10;
                this.initView(objWidth, objHeight);
                this.moveIt(x, y);
                this.food = 100;
            }
            function Food(x,y) {
                var objHeight = 10, objWidth = 10;
                this.initView(objWidth, objHeight);
                this.moveIt(x, y);
                this.amount = 100;
            }
            function Production(x,y) {
                var objHeight = 5, objWidth = 5;
                this.initView(objWidth, objHeight);
                this.moveIt(x, y);
                this.amount = 1;
            }
            Food.prototype = new Entity(0, 0);
            Ball.prototype = new Entity(0, 0);
            Production.prototype = new Entity(0, 0);
            Entity.prototype.initView = function() {
                this.$ = $('<div></div>');
                $("#box").append(this.$);
                this.$.addClass('ball');
                this.$.css('position','absolute');
            };
            Entity.prototype.moveIt = function(dx, dy) {
                var newTop = Math.round(this.$.position().top + dy);
                if (newTop < 0) {
                    newTop = 0;
                    this.vy = -looseSpeedOnCrash * this.vy;
                }
                if (newTop > boxHeight - this.$.height()) {
                    newTop = boxHeight - this.$.height();
                    this.vy = -looseSpeedOnCrash * this.vy;
                }
                this.$.css('top', newTop);
                var newLeft = Math.round(this.$.position().left + dx);
                if (newLeft < 0) {
                    newLeft = 0;
                    this.vx = -looseSpeedOnCrash * this.vx;
                }
                if (newLeft > boxWidth - this.$.width()) {
                    newLeft = boxWidth - this.$.width();
                    this.vx = -looseSpeedOnCrash * this.vx;
                }
                this.x = newLeft;
                this.y = newTop;
                this.$.css('left', newLeft);
            };
            Entity.prototype.updatePos = function() {
                this._pos = {
                    top: this.$.css('top'),
                    left: this.$.css('left'),
                    size: this.$.css('width')
                };
            };
            Entity.prototype.setSize = function(size) {
                this.$.css({width: size, height:size, borderRadius:size});
            };
            Entity.prototype.isIntersection = function(obj) {
                //var his = {top: 0, left: 0}, my = {top: 0, left: 0};
                var his = {top: parseInt(obj.$.css('top')), left: parseInt(obj.$.css('left'))};
                var my  = {top: parseInt(this.$.css('top')), left: parseInt(this.$.css('left'))};
                return  (his.top > my.top
                        && his.top < my.top + this.$.height()
                        && his.left > my.left
                        && his.left < my.left + this.$.width());
            };
            Entity.prototype.getDistTo = function(obj) {
                return Math.sqrt(Math.pow(this.x - obj.x, 2) + Math.pow(this.y-obj.y, 2));
            };
            Entity.prototype.getClosestObject = function(objects) {
                var me = this;
                var minDist = null;
                var result = null;
                objects.forEach(function(el) {
                    var dist = me.getDistTo(el);
                    if (dist == 0) {
                        return;
                    }
                    if (minDist == null || minDist > me.getDistTo(el)) {
                        minDist = dist;
                        result = el;
                    }
                });
                return {object: result, distance: minDist};
            };
            Ball.prototype.applyAcceleration = function(ax, ay) {
                var futureSpeed = Math.sqrt(Math.pow(this.vx + ax, 2) + Math.pow(this.vy + ay, 2));
                var k = 1;
                if (futureSpeed > maxSpeed) {
                    var aIn = Math.sqrt(Math.pow(ax, 2) + Math.pow(ay, 2));
                    var aMax = maxSpeed - Math.sqrt(Math.pow(this.vx, 2) + Math.pow(this.vy, 2));
                    k = aMax/aIn;
                }
                this.vx += k*ax;
                this.vy += k*ay;
            }
            Ball.prototype.behavePlay = function() {
                var closest = this.getClosestObject(balls);
                if (!closest.object || closest.distance > 300) {
                    return false;
                }
                var r = closest.distance;
                var partner = closest.object;
                var sign = 1;
                if (r < 25) {
                    sign = -1;
                }
                var unitAX = sign*(partner.x - this.x)/r;
                var unitAY = sign*(partner.y - this.y)/r;
                var ax = 500*unitAX/(r*r);
                var ay = 500*unitAY/(r*r);
                this.applyAcceleration(ax, ay);
                return true;
            };
            Ball.prototype.behaveRandom = function() {
                var ax = randSign()*Math.random()/3;
                var ay = randSign()*Math.random()/3;
                this.applyAcceleration(ax, ay);
                return true;
            };
            Ball.prototype.behaveFindFood = function() {
                var closestFood = this.getClosestObject(food);
                if (!closestFood.object) {
                    return false;
                }
                var r = closestFood.distance;
                var partner = closestFood.object;
                var ax = partner.x - this.x;
                var ay = partner.y - this.y;
                this.applyAcceleration(ax, ay);
                return true;
            };
            Ball.prototype.behave = function() {
                var intention = null;
                if (!intention && this.food < 10) {
                    var intention = this.behaveFindFood();
                }
                if (!intention) {
                    var intention = this.behavePlay();
                }
                this.behaveRandom();
            };
            Food.prototype.initView = function() {
                this.$ = $('<div></div>');
                $("#box").append(this.$);
                this.$.css('position','absolute');
                this.$.addClass('bread');
            };
            Food.prototype.feed = function() {
                var closestBall = this.getClosestObject(balls);
                if (!closestBall.object || closestBall.distance > 5) {
                    return false;
                }
                closestBall.object.food += 10;
                sounds.play('chaw');
                this.amount -= 10;
                return true;
            };
            Food.prototype.destroy = function() {
                food.splice( $.inArray(this, food), 1 );
                this.$.remove();
                delete this;
            };
            Production.prototype.initView = function() {
                this.$ = $('<div></div>');
                $("#box").append(this.$);
                this.$.css('position','absolute');
                this.$.addClass('production');
            }

            setInterval(function() {
                balls.forEach(function(ball, curObjIndex) {
                    ball.food--;
                    ball.behave();
                    var dx = ball.vx;
                    var dy = ball.vy;
                    ball.moveIt(dx, dy);
                });
                food.forEach(function(piece, curFoodIndex) {
                    piece.feed();
                    if (piece.amount <= 0) {
                        piece.destroy();
                    }
                });
            }, 40);

            main();
        })
    </script>
</head>
<body>
<div style="margin: 10px;">
    <div id="box" style="margin: 0 auto; border: 2px solid gray; position: relative; width:500px; height:500px;"></div>
    <div style="margin: 0 auto; text-align: center;">Balls: <span id="objects_cnt"></span></div>
    <div id="menu" style="margin: 0 auto; width: 500px;">
        <div id="bread" class="bread" style="float:left; margin:2px;"></div>
        <div id="ball" class="ball" style="float:left; margin:2px;"></div>
    </div>
</div>
</body>
</html>