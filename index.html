<!doctype html>
<html>
<head>
    <script src="js/jquery-2.0.3.js"></script>
    <style type="text/css">
        .ball {
            border-radius: 5px;
            background-color: blue;
            z-index: 3;
            width: 10px;
            height: 10px;
            z-index: 3;
        }
        .bread {
            background-color: brown;
            width: 10px;
            z-index: 2;
            height: 10px;
            z-index: 2;
        }
        .production {
            background-image:url('production.png');
            width: 10px;
            z-index: 1;
            height: 10px;
            z-index: 1;
            cursor: pointer;
        }
        #menu > div {
            cursor: pointer;
        }
        #menu > div.active {
            border:3px solid red;
        }
    </style>
    <script type="text/javascript">
        $(document).ready(function() {
            var soundOn = true;
            var isPause = false;
            var maxSpeed = 5;
            var looseSpeedOnCrash = 0.8;
            var ballPrice = 20;
            var breadPrice = 10;
            var productionProfit = 20;
            var playerMoney = 100;
            var breadAmount = 100;
            var foodAmountToProduct = 90;
            var mouse = {};
            var boxHeight = $('#box').height(), boxWidth = $('#box').width();
            var boxTop = $('#box').position().top, boxLeft = $('#box').position().left;
            var balls = [];
            var food = [];
            var production = [];

            var SoundLib = function() {
                this.sounds = {};
                var audioElement = document.createElement('audio');
                audioElement.setAttribute('src', 'chaw.mp3?1');
                audioElement.setAttribute('type', 'audio/mpeg');
                this.sounds.chaw = audioElement;

                audioElement = document.createElement('audio');
                audioElement.setAttribute('src', 'producted.mp3?1');
                audioElement.setAttribute('type', 'audio/mpeg');
                this.sounds.producted = audioElement;
            };
            SoundLib.prototype.play = function(soundName) {
                if (soundOn) {
                    this.sounds[soundName].play();
                }
            };
            var sounds = new SoundLib();

            $("#box").on("click", "div.production", function(e) {
                var me = $(this);
                console.log(me, production);
                production.forEach(function(el){
                    if (me.is(el.$)) {
                        el.transmit();
                    }
                });
                e.stopPropagation();
            });
            var mouseActionCreateBall = function(x, y) {
                if (playerMoney >= ballPrice) {
                    playerMoney -= ballPrice;
                    balls.push(new Ball(x, y));
                }
            };
            var mouseActionAddBread = function(x, y) {
                if (playerMoney >= breadPrice) {
                    playerMoney -= breadPrice;
                    food.push(new Food(x, y));
                }
            };
            function main() {
                $("#breadPrice").text('$' + breadPrice);
                $("#ballPrice").text('$' + ballPrice);
                var box = $("#box");
                box.width(boxWidth);
                box.height(boxHeight);
                balls.push(new Ball(boxWidth/2, boxHeight/2));
                $("#box").click(function(e) {
                    mouse.action(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
                    return false;
                });
                $("#menu div").click(function() {
                    $("#menu div").removeClass("active");
                    $(this).addClass("active");
                });
                $("#bread").click(function() {
                    mouse.action = mouseActionAddBread;
                });
                $("#ball").click(function() {
                    mouse.action = mouseActionCreateBall;
                });
                $("#sound").click(function(){
                    if (soundOn) {
                        soundOn = false;
                        $(this).text("off");
                    } else {
                        soundOn = true;
                        $(this).text("on");
                    }
                });
                $("#pause").click(function(){
                    if (isPause) {
                        isPause = false;
                        $(this).text("off");
                    } else {
                        isPause = true;
                        $(this).text("on");
                    }
                });
                mouse.action = mouseActionCreateBall;
            }
            function randSign() {
                var rnd;
                rnd = Math.random();
                if (rnd < 0.5) return -1;
                if (rnd == 0.5) return 0;
                return 1;
            }
            function Entity(x, y, arr) {
                x = x || 0;
                y = y || 0;
                this.vx = 0;
                this.vy = 0;
                this.x = 0;
                this.y = 0;
                this.classArray = arr;
            }
            function Ball(x, y) {
                var objHeight = 10, objWidth = 10;
                this.initView(objWidth, objHeight);
                this.moveIt(x, y);
                this.food = 0;
                this.producted = 0;
                this.amount = 100;
                this.isAgressive = false;
            }
            function Food(x,y) {
                var objHeight = 10, objWidth = 10;
                this.initView(objWidth, objHeight);
                this.moveIt(x, y);
                this.amount = breadAmount;
            }
            function Production(x,y) {
                var objHeight = 5, objWidth = 5;
                this.initView(objWidth, objHeight);
                this.moveIt(x, y);
                this.amount = 1;
            }
            Food.prototype = new Entity(0, 0, food);
            Ball.prototype = new Entity(0, 0, balls);
            Production.prototype = new Entity(0, 0, production);
            Entity.prototype.initView = function() {
                this.$ = $('<div></div>');
                $("#box").append(this.$);
                this.$.addClass('ball');
                this.$.css('position','absolute');
            };
            Entity.prototype.destroy = function() {
                this.classArray.splice( $.inArray(this, this.classArray), 1 );
                this.$.remove();
                delete this;
            };
            Entity.prototype.moveIt = function(dx, dy) {
                var newTop = Math.round(this.$.position().top + dy);
                if (newTop < 0) {
                    newTop = 0;
                    this.vy = -looseSpeedOnCrash * this.vy;
                }
                if (newTop > boxHeight - this.$.height()) {
                    newTop = boxHeight - this.$.height();
                    this.vy = -looseSpeedOnCrash * this.vy;
                }
                this.$.css('top', newTop);
                var newLeft = Math.round(this.$.position().left + dx);
                if (newLeft < 0) {
                    newLeft = 0;
                    this.vx = -looseSpeedOnCrash * this.vx;
                }
                if (newLeft > boxWidth - this.$.width()) {
                    newLeft = boxWidth - this.$.width();
                    this.vx = -looseSpeedOnCrash * this.vx;
                }
                this.x = newLeft;
                this.y = newTop;
                this.$.css('left', newLeft);
            };
            Entity.prototype.findIntersected = function(objects) {
                var found = this.getClosestObject(objects);
                if (found.object && this.$.width()/2 + found.object.$.width()/2 > found.distance) {
                    return found.object;
                }
                return null;
            };
            Entity.prototype.getDistTo = function(obj) {
                return Math.sqrt(Math.pow(this.x - obj.x, 2) + Math.pow(this.y-obj.y, 2));
            };
            Entity.prototype.getClosestObject = function(objects) {
                var me = this;
                var minDist = null;
                var result = null;
                objects.forEach(function(el) {
                    var dist = me.getDistTo(el);
                    if (dist == 0) {
                        return;
                    }
                    if (minDist == null || minDist > me.getDistTo(el)) {
                        minDist = dist;
                        result = el;
                    }
                });
                return {object: result, distance: minDist};
            };
            Ball.prototype.applyAcceleration = function(ax, ay) {
                var futureSpeed = Math.sqrt(Math.pow(this.vx + ax, 2) + Math.pow(this.vy + ay, 2));
                var k = 1;
                if (futureSpeed > maxSpeed) {
                    var aIn = Math.sqrt(Math.pow(ax, 2) + Math.pow(ay, 2));
                    var aMax = maxSpeed - Math.sqrt(Math.pow(this.vx, 2) + Math.pow(this.vy, 2));
                    k = aMax/aIn;
                }
                this.vx += k*ax;
                this.vy += k*ay;
            }
            Ball.prototype.behavePlay = function() {
                var closest = this.getClosestObject(balls);
                if (!closest.object || closest.distance > 300) {
                    return false;
                }
                var r = closest.distance;
                var partner = closest.object;
                var sign = 1;
                if (r < 25) {
                    sign = -1;
                }
                var unitAX = sign*(partner.x - this.x)/r;
                var unitAY = sign*(partner.y - this.y)/r;
                var ax = 500*unitAX/(r*r);
                var ay = 500*unitAY/(r*r);
                this.applyAcceleration(ax, ay);
                return true;
            };
            Ball.prototype.behaveRandom = function() {
                var ax = randSign()*Math.random()/3;
                var ay = randSign()*Math.random()/3;
                this.applyAcceleration(ax, ay);
                return true;
            };
            Ball.prototype.behaveFindFood = function() {
                var closestFood = this.getClosestObject(food);
                var color = "blue";
                this.isAgressive = false;
                if (!closestFood.object) {
                    closestFood = this.getClosestObject(balls);
                    if (closestFood.object) {
                        color = "red";
                        this.isAgressive = true;
                    } else {
                        return false;
                    }
                }
                this.$.css("background", color);
                var partner = closestFood.object;
                var ax = partner.x - this.x;
                var ay = partner.y - this.y;
                this.applyAcceleration(ax, ay);
                return true;
            };
            Ball.prototype.behaveProduct = function() {
                if (this.producted < foodAmountToProduct) {
                    return false;
                }
                production.push(new Production(this.x, this.y));
                if (this.producted - foodAmountToProduct < 0) {
                    this.producted = 0;
                } else {
                    this.producted =- foodAmountToProduct;
                }
                sounds.play('producted');
                return true;
            };
            Ball.prototype.behave = function() {
                var intention = null;
                if (!intention && this.food < 10) {
                    intention = this.behaveFindFood();
                }
                if (!intention) {
                    intention = this.behaveProduct();
                }
                if (!intention) {
                    intention = this.behavePlay();
                }
                this.behaveRandom();
            };
            Ball.prototype.consumeFood = function() {
                if (this.food > 0) {
                    this.producted++;
                    this.food--;
                }
            };
            Ball.prototype.feed = function() {
                var closestBall = this.findIntersected(balls);
                if (!closestBall || !closestBall.isAgressive) {
                    return false;
                }
                closestBall.food += 100;
                closestBall.$.css("background", "blue");
                sounds.play('chaw');
                this.amount -= 100;
                return true;
            };
            Food.prototype.initView = function() {
                this.$ = $('<div></div>');
                $("#box").append(this.$);
                this.$.css('position','absolute');
                this.$.addClass('bread');
            };
            Food.prototype.feed = function() {
                var intersectedObj = this.findIntersected(balls);
                if (!intersectedObj) {
                    return false;
                }
                intersectedObj.food += 10;
                sounds.play('chaw');
                this.amount -= 10;
                return true;
            };
            Production.prototype.initView = function() {
                this.$ = $('<div></div>');
                $("#box").append(this.$);
                this.$.css('position','absolute');
                this.$.addClass('production');
            };
            Production.prototype.transmit = function() {
                playerMoney += productionProfit;
                this.destroy();
            };
            //main cycle
            setInterval(function() {
                if (isPause) {
                    return;
                }
                balls.forEach(function(ball, curObjIndex) {
                    ball.behave();
                    var dx = ball.vx;
                    var dy = ball.vy;
                    ball.moveIt(dx, dy);
                });
                food.forEach(function(piece, curFoodIndex) {
                    piece.feed();
                    if (piece.amount <= 0) {
                        piece.destroy();
                    }
                });
                balls.forEach(function(ball, curObjIndex) {
                    ball.feed();
                    if (ball.amount <= 0) {
                        ball.destroy();
                    }
                });
            }, 40);
            //waste food
            setInterval(function() {
                if (isPause) {
                    return;
                }
                balls.forEach(function(ball, curObjIndex) {
                    ball.consumeFood();
                });
            }, 100);
            //update info
            setInterval(function () {
                if (isPause) {
                    return;
                }
                $('#objects_cnt').text(balls.length);
                $('#money').text('$' + playerMoney);
            }, 500);
            main();
        })
    </script>
</head>
<body>
<div style="margin: 10px;">
    <div id="box" style="margin: 0 auto; border: 2px solid gray; position: relative; width:500px; height:500px;"></div>
    <div style="margin: 0 auto; text-align: center;" id="info">
        Balls: <span id="objects_cnt"></span><br />
        Ballance: <span id="money"></span>
    </div>
    <div id="menu" style="margin: 0 auto; width: 500px;">
        <div id="bread">
            <span id="breadPrice"></span>
            <div class="bread" style="float:left; margin:2px;"></div>
        </div>
        <div id="ball" class="active">
            <span id="ballPrice"></span>
            <div class="ball" style="float:left; margin:2px;"></div>
        </div>
    </div>
    <div style="margin:0 auto; width:500px; text-align: right;">
        Sound: <a id="sound" href="#">on</a><br />
        Pause: <a id="pause" href="#">off</a>
    </div>
</div>
</body>
</html>